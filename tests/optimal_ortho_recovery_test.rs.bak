use fold::{file_handler, interner::Interner, ortho::Ortho};
use std::fs;
use tempfile::TempDir;

#[test]
fn test_optimal_ortho_saved_and_loaded() {
    // Create a temp directory for testing
    let temp_dir = TempDir::new().unwrap();
    let archive_path = temp_dir.path().join("test_archive");

    // Create test interner
    let interner = Interner::from_text("the quick brown fox");

    // Create a test ortho with some structure
    let mut ortho = Ortho::new();
    ortho = ortho.add(0).into_iter().next().unwrap();
    ortho = ortho.add(1).into_iter().next().unwrap();

    // Calculate expected score
    let volume = ortho.dims().iter().map(|&d| d - 1).product::<usize>();
    let fullness = ortho.payload().iter().filter(|x| x.is_some()).count();

    // Manually create archive structure (simulating what main.rs does)
    fs::create_dir_all(&archive_path).unwrap();

    // Save interner
    let interner_path = archive_path.join("interner.bin");
    let interner_bytes = bincode::encode_to_vec(&interner, bincode::config::standard()).unwrap();
    fs::write(interner_path, interner_bytes).unwrap();

    // Save optimal ortho in binary format
    let optimal_bin_path = archive_path.join("optimal.bin");
    let optimal_bytes = bincode::encode_to_vec(&ortho, bincode::config::standard()).unwrap();
    fs::write(optimal_bin_path, optimal_bytes).unwrap();

    // Write other required files
    let lineage_path = archive_path.join("lineage.txt");
    fs::write(lineage_path, "\"test\"").unwrap();

    let metadata_path = archive_path.join("metadata.txt");
    fs::write(metadata_path, "1").unwrap();

    // Now test loading the optimal ortho back
    let loaded_ortho = file_handler::load_optimal_ortho(archive_path.to_str().unwrap())
        .expect("Should load optimal ortho");

    // Verify the loaded ortho matches the original
    assert_eq!(loaded_ortho.id(), ortho.id());
    assert_eq!(loaded_ortho.dims(), ortho.dims());
    assert_eq!(loaded_ortho.payload(), ortho.payload());

    // Verify score calculation still works
    let loaded_volume = loaded_ortho
        .dims()
        .iter()
        .map(|&d| d - 1)
        .product::<usize>();
    let loaded_fullness = loaded_ortho
        .payload()
        .iter()
        .filter(|x| x.is_some())
        .count();
    assert_eq!(loaded_volume, volume);
    assert_eq!(loaded_fullness, fullness);
}

#[test]
fn test_load_optimal_ortho_missing_file() {
    // Create a temp directory for testing
    let temp_dir = TempDir::new().unwrap();
    let archive_path = temp_dir.path().join("empty_archive");
    fs::create_dir_all(&archive_path).unwrap();

    // Try to load from archive without optimal.bin - should error
    let result = file_handler::load_optimal_ortho(archive_path.to_str().unwrap());

    // Should return an error when file doesn't exist
    assert!(result.is_err());
}
